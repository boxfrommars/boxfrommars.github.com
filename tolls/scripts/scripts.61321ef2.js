"use strict";angular.module("tollsApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainController",controllerAs:"MainCtrl"})}]),angular.module("tollsApp").controller("MainController",["$http","leafletData",function(a,b){var c="//rnd.fasten.com",d=new L.FeatureGroup,e=new L.FeatureGroup,f=this;f.tracks=[],f.markers=[],f.currentTrack=null,f.track=null,f.entranceAreaRadius=2e-4,f.angleCoeff=10,f.anglePower=4,f.distanceCoeff=.17,f.distancePower=1,f.distanceMax=10;var g=[{code:"EN1",coordinates:[{lat:42.34789571323296,lng:-71.06101334095001,id:0},{lat:42.34717413897111,lng:-71.06161415576935,id:1},{lat:42.34694418499349,lng:-71.06207549571991,id:2},{lat:42.346904537670945,lng:-71.06280505657196,id:3},{lat:42.346920396602954,lng:-71.06350243091583,id:4,entranceTo:12}]},{code:"EN2",coordinates:[{lat:42.34665872371306,lng:-71.06118500232697,id:100},{lat:42.34669837119064,lng:-71.06195747852325,id:101},{lat:42.34681731347333,lng:-71.06281578540802,id:102},{lat:42.346920396602954,lng:-71.06350243091583,id:103,entranceTo:12}]}],h=[{code:"EX1",coordinates:[{lat:42.355293353966324,lng:-71.11847698688507,id:5},{lat:42.35553120577965,lng:-71.11850917339324,id:6},{lat:42.35618132947636,lng:-71.1187881231308,id:7},{lat:42.35668081018698,lng:-71.119185090065,id:8}]},{code:"EX2",coordinates:[{lat:42.35087707511597,lng:-71.11142814159393,id:9},{lat:42.3511902684889,lng:-71.11167222261429,id:10},{lat:42.35155896248497,lng:-71.1119082570076,id:11}]}],i=[{lat:42.346920396602954,lng:-71.06350243091583,id:12},{lat:42.34703140901506,lng:-71.06387257575989,id:13},{lat:42.34733272743112,lng:-71.0651171207428,id:14},{lat:42.34757060937097,lng:-71.06642067432404,id:15},{lat:42.34776884363319,lng:-71.06793344020844,id:16},{lat:42.34788778389048,lng:-71.06937110424042,id:17},{lat:42.34788778389048,lng:-71.07088387012482,id:18},{lat:42.34789571323296,lng:-71.07216060161589,id:19},{lat:42.34789571323296,lng:-71.07349097728729,id:20},{lat:42.34781641976309,lng:-71.08956277370453,id:21},{lat:42.34784813716305,lng:-71.0910540819168,id:22},{lat:42.347832278465084,lng:-71.09260976314545,id:23},{lat:42.347832278465084,lng:-71.09417617321013,id:24},{lat:42.34780056105714,lng:-71.09588205814362,id:25},{lat:42.34782434911458,lng:-71.09746992588043,id:26},{lat:42.347792631702646,lng:-71.09924018383026,id:27},{lat:42.34787192520248,lng:-71.10080659389496,id:28},{lat:42.348086017152475,lng:-71.10199749469757,id:29},{lat:42.348458693992754,lng:-71.10413253307343,id:30},{lat:42.348767934799874,lng:-71.10574185848236,id:31},{lat:42.34906924489222,lng:-71.10720098018646,id:32},{lat:42.349481561625495,lng:-71.1085957288742,id:33},{lat:42.35007624445802,lng:-71.10997974872589,id:34},{lat:42.35087707511597,lng:-71.11142814159393,id:35,exitTo:{code:"EX2",id:9}},{lat:42.35146381585433,lng:-71.11261904239655,id:36},{lat:42.351907832231745,lng:-71.11368119716644,id:37},{lat:42.35236770303022,lng:-71.11461460590363,id:38},{lat:42.35296235855687,lng:-71.115762591362,id:39},{lat:42.353588722960616,lng:-71.11693203449249,id:40},{lat:42.354326080651326,lng:-71.11786544322966,id:41},{lat:42.355293353966324,lng:-71.11847698688507,id:42,exitTo:{code:"EX1",id:5}},{lat:42.3558562684687,lng:-71.11879885196686,id:43},{lat:42.35644296272466,lng:-71.11932456493378,id:44},{lat:42.35690280033964,lng:-71.11988246440887,id:45},{lat:42.35724371226148,lng:-71.1204832792282,id:46},{lat:42.35742605973958,lng:-71.12112700939178,id:47},{lat:42.3575370535976,lng:-71.1218672990799,id:48}],j={track:{color:"red",weight:2,latlngs:[],message:"<h3>Route from London to Rome</h3><p>Distance: 1862km</p>"}};_.each(g,function(a){j[a.code]={color:"blue",weight:4,latlngs:a.coordinates,message:"<h3>"+a.code+"</h3>"},f.markers=f.markers.concat(_.map(a.coordinates,function(a){return _.extend({message:JSON.stringify(a),icon:{type:"awesomeMarker",icon:"dot",markerColor:"blue"}},a)}))}),_.each(h,function(a){j[a.code]={color:"purple",weight:4,latlngs:a.coordinates,message:"<h3>"+a.code+"</h3>"},f.markers=f.markers.concat(_.map(a.coordinates,function(a){return _.extend({message:JSON.stringify(a)},a)}))}),j.toll={color:"green",weight:4,latlngs:i,message:"<h3>Toll</h3>"},f.markers=f.markers.concat(_.map(i,function(a){return _.extend({message:JSON.stringify(a),icon:{type:"awesomeMarker",icon:"dot",markerColor:"green"}},a)})),f.map={controls:{position:"topright",draw:{polyline:{},polygon:!1,rectangle:!1,circle:!1,marker:!1},edit:{featureGroup:d,remove:!1}},center:{lat:42.347638,lng:-71.058187,zoom:14},layers:{baselayers:{googleRoadmap:{name:"Google Streets",layerType:"ROADMAP",type:"google"}}},paths:j},b.getMap().then(function(a){a.addLayer(d),a.addLayer(e),a.on("draw:created",function(a){var b=a.layer;d.addLayer(b);var c=b.toGeoJSON().geometry.coordinates.map(function(a){return{lat:+a[1],lng:+a[0]}});console.log("WAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA",p(c[0],c[1])),f.markers=c,console.log(JSON.stringify(c))})});var k=function(a,b){return a&&b?b.lat==a.lat&&b.lng==a.lng:!1},l=function(a,b){return a.lat*b.lat+a.lng*b.lng},m=function(a,b){return l(o(a[0],a[1]),o(b[0],b[1]))/Math.sqrt(Math.abs(l(o(a[0],a[1]),o(a[0],a[1]))*l(o(b[0],b[1]),o(b[0],b[1]))))},n=function(a,b){return{lat:b.lat-a.lat,lng:b.lng-a.lng}},o=function(a,b){return{lat:1e5*(b.lat-a.lat),lng:1e5*(b.lng-a.lng)}},p=function(a,b){var c=n(a,b);return Math.sqrt(c.lat*c.lat+c.lng*c.lng)},q=function(a,b){var c=n(b[0],b[1]),d=l(n(b[0],a),c);if(0>=d)return p(a,b[0]);var e=l(c,c);if(d>=e)return p(a,b[1]);var f=Math.sqrt(Math.abs(e));return((b[0].lng-b[1].lng)*a.lat+(b[1].lat-b[0].lat)*a.lng+b[0].lat*b[1].lng-b[0].lng*b[1].lat)/f},r=function(a,b){var c=function(a){var b=function(a){var b=!1,c=_.findWhere(h,{code:a.code}),e=_.findWhere(c.coordinates,{id:a.id}),f=null;_.each(c.coordinates,function(a){a.id==e.id&&(b=!0),b&&(d[a.id]={point:a,adjacencyList:[],isExit:!0},f&&d[f.id].adjacencyList.push(a.id),f=a)})},c=!1,e=_.findWhere(i,{id:a}),f=null;_.each(i,function(a){a.id==e.id&&(c=!0),c&&(d[a.id]={point:a,adjacencyList:[]},f&&d[f.id].adjacencyList.push(a.id),f=a,a.exitTo&&(b(a.exitTo),d[a.id].adjacencyList.push(a.exitTo.id)))})},d={},e=!1,f=b[0],g=null;return _.each(a.coordinates,function(a){a.id==f.id&&(e=!0),e&&(d[a.id]={point:a,adjacencyList:[]},g&&d[g.id].adjacencyList.push(a.id),g=a,a.entranceTo&&(d[a.id].adjacencyList.push(a.entranceTo),c(a.entranceTo)))}),d},s=function(a,b){var c=[];return _.each(b.adjacencyList,function(d){c.push([b,a[d]]),c=c.concat(s(a,a[d]))}),c},t=function(a,b){var c=[a[0].point,a[1].point],d=Math.abs(1e5*q(b[1],c)),e=m(c,b),g=f.distanceMax-f.distanceCoeff*Math.pow(d,f.distancePower),h=f.angleCoeff*Math.pow(e,f.anglePower);return{distance:d,distanseMeasure:g,cos:h,total:h+g}},u=function(a,b,c){var d=b[0].id,e=c[d],g=null,h=null,i=s(c,e);return _.each(i,function(b){if(!k(b[0].point,b[1].point)){var c=t(b,a);(_.isNull(g)||c.total>g.total)&&(g=c,h=b)}}),g.total>10&&!_.isNull(g)?(console.log(a,g),f.markers.push(_.extend({message:JSON.stringify({edge:a,result:g}),icon:{type:"awesomeMarker",icon:"dot",markerColor:h[1].isExit?"red":"black"}},a[1])),{success:!0,trackResult:g,tollEdge:h,trackEdge:a}):(f.markers.push(_.extend({message:JSON.stringify({edge:a,result:g}),icon:{type:"awesomeMarker",icon:"dot",markerColor:"green"}},a[1])),console.log("WAAAAAAAAAAAAAA",a,g),{success:!1,trackResult:g,tollEdge:h,trackEdge:a})},v=function(a,b,c,d){var e=0,f=!1,g=b,h=r(a,b);console.log(h);for(var i=d.length-1,j=0;i>j;j++){var l=d.slice(j,j+2);if(!k(l[0],l[1])){var m=u(l,g,h);if(m.success)e=0,g[1].isExit;else if(e++,e>2)return{success:!1}}}return{success:f}};f.calculateTolls=function(){f.markers=[];var a,b=[];_.every(f.track,function(c,d){var e=null,h=null,i=null;return _.each(g,function(a){var b=null;_.each(a.coordinates,function(d){if(b&&!k(d,b)){var f=q(c,[b,d]);(e>f||_.isNull(e))&&(e=f,h=[b,d],i=a)}b=d})}),Math.abs(e)<=f.entranceAreaRadius?(console.log(e,c,i.code,h),f.markers.push(_.extend({message:JSON.stringify(c),icon:{type:"awesomeMarker",icon:"dot",markerColor:"red"}},c)),a=v(i,h,c,f.track.slice(d)),console.log(a),a.success?(b.push(),!0):!0):!0})};var w=function(){f.calculateTolls()};f.trackSelected=function(){a.post(c+"/gettrack","track="+f.currentTrack.id,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){f.map.paths.track.latlngs=[],f.track=[],_.each(a.coords,function(a,b){var c={lat:+a[0],lng:+a[1]};f.map.paths.track.latlngs.push(c),f.track.push(c)}),w()})},a.get(c+"/list").success(function(a){f.tracks=_.map(a.tracks,function(a,b){return{name:a,id:b}}),f.currentTrack=_.findWhere(f.tracks,{id:"61"}),f.trackSelected()})}]);